<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\visual\Composite.js - DreamJs</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title="DreamJs"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.8</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\visual\Composite.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * @constructor
 *&#x2F;
dream.visual.Composite = function(left, top){
	dream.visual.Composite._superClass.call(this, left, top);
	var composite = this;
	
	&#x2F;&#x2F;this.rect = new dream.Rect(left, top);
	this._isDirty = false;
	this._isPresent = false;
	this.assets = new dream.util.AssetLibrary();
	this.renderList = [];
	this.pool = new dream.collection.Set;
	
	this.redrawRegions = new dream.util.RedrawRegionList();
	
	this.assets.onAdd.add(function(a){
		if(a instanceof dream.visual.Graphic){
			
			composite.pool.add(a);
			var z = a.z;
			(composite.renderList[z] || (composite.renderList[z] = [])).push(a);
			a.onZChange.add(function(oldZ){
				var ol = composite.renderList[oldZ];
				ol.splice(ol.indexOf(this), 1);
				(composite.renderList[this.z] || (composite.renderList[this.z] = [])).push(this);
			}, this);
			
			
			composite.addToRect(a);
			
			a.isImageChanged = true;
			
			a.onBoundaryChange.add(composite.addToRect.bind(composite, a), composite);
			
			if(!composite._isDirty)
				a.onImageChange.add(composite.redrawRegions.addArray.bind(composite.redrawRegions), composite);
			
		};
	});
	this.assets.onRemove.add(function(a){
		if(a instanceof dream.visual.Graphic){
			a.onBoundaryChange.removeByOwner(composite);
			a.onImageChange.removeByOwner(composite);
			a.onZChange.removeByOwner(composite);
			composite.renderList[a.z].splice(composite.renderList[a.z].indexOf(a),1);
			composite.pool.remove(a);
		}
	});
}.inherits(dream.visual.Graphic);

Object.defineProperty(dream.visual.Composite.prototype, &quot;isDirty&quot;, {
	set: function(v){
		if(this._isDirty == v) return v;
		this._isDirty = v;
		if(v){
			for(var i=0, obj; obj = this.assets[i]; i++)
				obj.onImageChange.removeByOwner(this);
		}else{
			for(var i=0, obj; obj = this.assets[i]; i++)
				obj.onImageChange.add(function(rects){
					this.redrawRegions.addArray(rects);
				}, this);
		}
	},
	get : function () {
		return this._isDirty;
	}
});

Object.defineProperty(dream.visual.Composite.prototype, &quot;isPresent&quot;, {
	set: function(v){
		if(this._isPresent == v) return v;
		this._isPresent = v;
		for(var i=0, obj; obj = this.pool[i]; i++)
			obj.isPresent = v;
	},
	get : function () {
		return this._isPresent;
	}
});

dream.visual.Composite.prototype.addToRect = function(g){
	var vr = g.boundary;
	if(!this.rect.covers(vr)){
		this.rect = this.rect.add(vr);
		this.isBoundaryChanged = true;
	}
};


dream.visual.Composite.prototype.step = function (){
	
	for(var i = 0, l = this.pool.length; i &lt; l; i++){
		this.pool[i].step();
	}

	dream.visual.Composite._superClass.prototype.step.call(this);
	
	if(this._isDirty){
		dream.event.dispatch(this, &quot;onImageChange&quot;, [this.boundary]);
	}else if(this.redrawRegions.length){
		dream.event.dispatch(this, &quot;onImageChange&quot;, this.redrawRegions.map(function(r){return this.rect.transformation.projectRect(r).boundary;}, this) );
		this.redrawRegions.clear();
	}
	
}; 

dream.visual.Composite.prototype.paint = function(ctx, origin, renderRect) {
	if(!renderRect || renderRect.covers(this.boundary)){
		for(var zi in this.renderList){
			var rl = this.renderList[zi];
			for(var i = 0, l = rl.length; i &lt; l; i++){
				rl[i].render(ctx, origin, this.rect);
			}		
		}		
	}else{
		var ldr = this.rect.transformation.unprojectRect(renderRect).boundary;
		for(var zi in this.renderList){
			var rl = this.renderList[zi];
			for(var i = 0, l = rl.length; i &lt; l; i++){
				var g = rl[i];
				if(g.boundary.hasIntersectWith(ldr)){
					g.render(ctx, origin, ldr);
				}
			}
		}		
	}
};

dream.visual.Composite.prototype.checkHover = function(event){
	if(event.position.isIn(this.boundary)){
		
		var zs = [];
		for(var zi in this.renderList){
			zs.push(zi);
		}

		var l, z = this.renderList;
		while(l = z[zs.pop()])
			for(var i = l.length -1 , g; g = l[i]; i--){
				if(g.checkHover(event.toLocal(g))){
					if(this.hovered &amp;&amp; this.hovered != g){
						this.hovered.raiseMouseLeave(event);
					}
					this.hovered = g;
					event.restore();
					if(!this.isHovered) dream.event.dispatch(this, &quot;onMouseEnter&quot;, event);
					this.isHovered = true;
					return true;
				}else{
					event.restore();
				}
				
			}
	}
	if(this.hovered){
		this.hovered.raiseMouseLeave(event.toLocal(this.hovered));
		this.hovered = null;
	}

	return false;
};

Object.defineProperty(dream.visual.Composite.prototype, &quot;requiredResources&quot;, {
	get : function () {
		return this.assets.requiredResources;
	}
});

dream.visual.Composite.prototype.destroy = function(){
	this.pool.clear();		
};


dream.visual.Composite.prototype.raiseMouseDown = dream.VisualAsset.prototype.raiseMouseDown;
dream.visual.Composite.prototype.raiseMouseUp = dream.VisualAsset.prototype.raiseMouseUp;
dream.visual.Composite.prototype.raiseMouseMove = dream.VisualAsset.prototype.raiseMouseMove;
dream.visual.Composite.prototype.raiseMouseLeave = dream.VisualAsset.prototype.raiseMouseLeave;
dream.visual.Composite.prototype.raiseDrag = dream.VisualAsset.prototype.raiseDrag;
dream.visual.Composite.prototype.raiseDragStop = dream.VisualAsset.prototype.raiseDragStop;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
